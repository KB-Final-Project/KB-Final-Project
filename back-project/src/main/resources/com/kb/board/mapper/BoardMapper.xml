<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kb.board.mapper.BoardMapper">

    <resultMap type="com.kb.board.dto.BoardDTO" id="boardResultMap">
        <id property="bno" column="bno"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="status" column="status"/> <!-- 상태 필드 -->
    </resultMap>

    <resultMap type="com.kb.board.dto.BoardCategory" id="boardCategoryMap">
        <id property="id" column="id"/>
        <result property="type" column="type"/>
        <result property="name" column="name"/>
        <result property="level" column="level"/>
        <result property="orderNo" column="order_no"/>
    </resultMap>

    <resultMap type="com.kb.board.dto.BoardPostDTO" id="boardPostResultMap">
        <id property="boardId" column="board_id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="readCount" column="read_count"/>
        <result property="createdDate" column="created_date"/>
        <result property="modifiedDate" column="modified_date"/>
        <result property="type" column="board_category"/> <!-- 카테고리 타입 -->
        <result property="commentCount" column="comment_count"/>
        <result property="likesCount" column="likes_count"/>
        <result property="memberId" column="member_id"/>
    </resultMap>

    <!-- board 카테고리 가져오는 select문 -->
    <select id="selectBoardCategory" resultMap="boardCategoryMap">
        SELECT * FROM board_category ORDER BY id;
    </select>

    <select id="selectBoardList" parameterType="com.kb.board.dto.BoardParam" resultMap="boardResultMap">
    <![CDATA[
        SELECT
            b.bno, b.type, b.title,
            b.content, b.status
        FROM board b
        WHERE
            b.status = 'y'
        ORDER BY b.bno DESC
            LIMIT #{limit} OFFSET #{offset}
        ]]>
    </select>

    <select id="selectBoardCount" parameterType="com.kb.board.dto.BoardParam" resultType="int">
    <![CDATA[
        SELECT COUNT(DISTINCT b.bno)
        FROM board b
        WHERE
            b.status = 'y'
        ]]>
    </select>

    <select id="selectBoardByBno" parameterType="long" resultMap="boardResultMap">
        SELECT
            b.bno, b.type, b.title, b.content, b.status
        FROM board b
        WHERE b.status = 'y' AND b.bno = #{bno}
    </select>

    <insert id="insertBoard" parameterType="com.kb.board.dto.BoardDTO">
        <selectKey keyProperty="bno" resultType="long" order="AFTER">
            SELECT LAST_INSERT_ID() AS bno
        </selectKey>
        INSERT INTO board (bno, type, title, content, status)
        VALUES (DEFAULT, #{type}, #{title}, #{content}, #{status})
    </insert>

    <update id="updateBoard" parameterType="com.kb.board.dto.BoardDTO">
        UPDATE board SET
                         type=#{type}, title=#{title}, content=#{content}, status=#{status}
        WHERE bno = #{bno}
    </update>

    <update id="deleteBoard" parameterType="long">
        UPDATE board SET
            status = 'n'
        WHERE bno = #{bno}
    </update>

    <!-- board_post 관련 쿼리 -->
    <select id="selectBoardPostList" parameterType="com.kb.board.dto.BoardParam" resultMap="boardPostResultMap">
        <![CDATA[
        SELECT
            bp.board_id,
            bp.title,
            bp.content,
            bp.read_count,
            bp.created_date,
            bp.modified_date,
            bp.board_category,
            bp.comment_count,
            bp.likes_count,
            bp.member_id
        FROM board_post bp
        ORDER BY bp.board_id DESC
            LIMIT #{limit} OFFSET #{offset}
        ]]>
    </select>

    <select id="selectBoardPostById" parameterType="int" resultMap="boardPostResultMap">
        <![CDATA[
        SELECT
            bp.board_id,
            bp.title,
            bp.content,
            bp.read_count,
            bp.created_date,
            bp.modified_date,
            bp.board_category,
            bp.comment_count,
            bp.likes_count,
            bp.member_id
        FROM board_post bp
        WHERE bp.board_id = #{boardId}
        ]]>
    </select>

    <insert id="insertBoardPost" parameterType="com.kb.board.dto.BoardPostDTO">
        <selectKey keyProperty="boardId" resultType="int" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
        <![CDATA[
        INSERT INTO board_post (title, content, member_id, board_category)
        VALUES (#{title}, #{content}, #{memberId}, #{type})
        ]]>
    </insert>

    <update id="updateBoardPost" parameterType="com.kb.board.dto.BoardPostDTO">
        <![CDATA[
        UPDATE board_post
        SET title = #{title},
            content = #{content},
            modified_date = CURRENT_TIMESTAMP,
            board_category = #{type}
        WHERE board_id = #{boardId}
        ]]>
    </update>

    <update id="deleteBoardPost" parameterType="int">
        <![CDATA[
        DELETE FROM board_post WHERE board_id = #{boardId}
        ]]>
    </update>

</mapper>
